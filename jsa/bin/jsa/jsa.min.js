(function(){"use strict";if("undefined"==typeof e){var t=this,e=function(){};e.JSA=function(t,i,a){this.pack=e.fromJson(t,this),this.zip=i,this.textureHandler=a},e.JSAType={},e.JSAType.PACK=1,e.JSAType.FOLDER=2,e.JSAType.FILE=3,e.JSAType.SEP_PATH="/",e.JSADataType={},e.JSADataType.NORMAL_PNG=1,e.JSADataType.NORMAL_JPG=2,e.JSADataType.GRAY_SCALE_JPG=3,e.JSADataType.ALPHA_PNG=4,e.JSADataType.INVERSE_ALPHA_PNG=5,e.JSADataType.GRAY_SCALE_PNG=6,e.JSADataType.NORMAL_PNG8=7,e.JSADataType.TEXTURE_PNG=9,e.JSADataType.TEXTURE_PNG8=10,e.JSADataType.TEXTURE_JPG=11,e.textureHandler=function(){},e.isTexture=function(t){return t==e.JSADataType.TEXTURE_PNG||t==e.JSADataType.TEXTURE_PNG8||t==e.JSADataType.TEXTURE_JPG?!0:!1},e.JSAPack=function(){this.init()},e.JSAPack.prototype.init=function(){this.inited||(this.inited=!0,this.jsa=null,this.fileNum=0,this.itemNum=0)},e.JSAPack.prototype.getData=function(){var t=this.data;return t&&t.loadImage(),t},e.JSAInfo=function(){this.init()},e.JSAInfo.prototype.init=function(){this.inited||(this.inited=!0)},e.JSAData=function(){this.init()},e.JSAData.EVENT_LOADED="JSADataLoaded",e.JSAData.prototype.init=function(){this.inited||(this.inited=!0,e.EventTarget.call(this),this.texture=null,this.pack=null,this.img=null,this.imgSrc=null,this.imgMask=null)},e.JSAData.prototype.onloadHandler=function(t,i){this.imgSrc&&(this.imgSrc.complete||i)&&this.imgMask&&(this.imgMask.complete||i)&&(this.img.src=e.getMaskImg(this.imgSrc,this.imgMask,this.type,this.offset),this.oncomplet())},e.JSAData.prototype.onerrorHandler=function(){this.oncomplet()},e.JSAData.prototype.onabortHandler=function(){this.oncomplet()},e.JSAData.prototype.oncomplet=function(){this.resetImgHandler(this.imgSrc),this.resetImgHandler(this.imgMask),this.imgSrc=null,this.imgMask=null,this.loading=!1,this.dispatchEvent({type:e.JSAData.EVENT_LOADED,data:this.img})},e.JSAData.prototype.resetImgHandler=function(t){t&&(t.onload=null,t.onerror=null,t.onabort=null)},e.JSAData.prototype.loadImage=function(){var t,i,a,n,o,r,s=this,p=s.pack,l=p.jsa;if(e.isTexture(s.type)){var c=l.textureHandler||e.textureHandler;return c.call(l,s)}return s.img&&s.img.src||(s.img||(s.img=new Image),s.img.name=p.path,n=p.path.split(e.JSAType.SEP_PATH),s.mask?s.loading||(s.loading=!0,n[n.length-1]=s.src,o=l.zip.file(n.join(e.JSAType.SEP_PATH)),i=o.asUint8Array(),r=new Blob([i],{type:"image/jpeg"}),s.imgSrc=new Image,s.imgSrc.onload=function(){s.onloadHandler()},s.imgSrc.onerror=function(){s.onerrorHandler()},s.imgSrc.onabort=function(){s.onabortHandler},s.imgSrc.src=(window.URL||window.webkitURL).createObjectURL(r),n[n.length-1]=s.mask,o=l.zip.file(n.join(e.JSAType.SEP_PATH)),a=o.asUint8Array(),t="image/png",s.type==e.JSADataType.GRAY_SCALE_JPG&&(t="image/jpeg"),r=new Blob([a],{type:t}),s.imgMask=new Image,s.imgMask.onload=function(){s.onloadHandler()},s.imgMask.onerror=function(){s.onerrorHandler()},s.imgMask.onabort=function(){s.onabortHandler()},s.imgMask.src=(window.URL||window.webkitURL).createObjectURL(r),s.onloadHandler()):s.src&&(s.img||(s.img=new Image),n[n.length-1]=s.src,o=l.zip.file(n.join(e.JSAType.SEP_PATH)),i=o.asUint8Array(),t="image/jpeg",s.type==e.JSADataType.NORMAL_PNG&&(t="image/png"),r=new Blob([i],{type:t}),s.img.src=(window.URL||window.webkitURL).createObjectURL(r))),s.img},e.JSA.prototype.getPackItem=function(t){var i,a,n,o=this.pack,r=o;for(i=t.split(e.JSAType.SEP_PATH),a=0;a<i.length;a+=1){if(!o.items||0==o.items.length){r=null;break}for(n=0;n<o.items.length&&(r=o.items[n],r.name!==i[a]);n+=1);if(n>=o.items.length){r=null;break}o=r}return r},e.JSA.prototype.getPackData=function(t){return t.getData()},e.JSA.prototype.getPackItemData=function(t,i){var a,n=this.getPackItem(t),o=function(){"function"==typeof i&&i.call(null,n)};return n?(a=this.getPackData(n),a&&!a.img.src?a.addEventListener(e.JSAData.EVENT_LOADED,o):o()):o(),a},e.fromJson=function(t,i){var a,n=0,o=0;if(t){if(t.__proto__=e.JSAPack.prototype,t.init(),t.jsa=i,t.info&&!t.info.inited&&(t.info.__proto__=e.JSAInfo.prototype,t.info.init()),t.items)for(n=0;n<t.items.length;n+=1)a=t.items[n],a.type==e.JSAType.FILE&&(o+=1),a.info&&!a.info.inited?(a.info.__proto__=e.JSAInfo.prototype,a.info.init()):a.info=t.info,e.fromJson(a,i);t.itemNum=n,t.fileNum=o,t.data&&(t.data.__proto__=e.JSAData.prototype,t.data.init(),t.data.pack=t)}return t},e.getCanvas=function(){return e.canvas||(e.canvas=document.createElement("canvas"),e.canvas.style.display="none"),e.canvas},e.getMaskImg=function(t,i,a,n){var o,r=n?Number(n[2]):t.width,s=n?Number(n[3]):t.height,p=e.getCanvas();return p.width=r,p.height=s,o=p.getContext("2d"),o.clearRect(0,0,r,s),o.drawImage(t,0,0,r,s),o.globalCompositeOperation="xor",a==e.JSADataType.GRAY_SCALE_JPG||a==e.JSADataType.GRAY_SCALE_PNG?i=e.grayScale2InverseAlphaMask(i,n):a==e.JSADataType.ALPHA_PNG&&(o.globalCompositeOperation="destination-in"),o.drawImage(i,0,0,r,s),p.toDataURL("image/png")},e.grayScale2InverseAlphaMask=function(t,e){var i,a,n,o,r=e?Number(e[2]):t.width,s=e?Number(e[3]):t.height,p=document.createElement("canvas");for(p.width=r,p.height=s,o=p.getContext("2d"),o.drawImage(t,0,0,r,s),i=o.getImageData(0,0,r,s),a=i.data,n=a.length-1;n>0;n-=4)a[n]=255-a[n-3];return o.clearRect(0,0,r,s),o.putImageData(i,0,0),p},e.EventTarget=function(){var t={};this.addEventListener=this.on=function(e,i){void 0===t[e]&&(t[e]=[]),-1===t[e].indexOf(i)&&t[e].push(i)},this.dispatchEvent=this.emit=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=this.off=function(e,i){var a=t[e].indexOf(i);-1!==a&&t[e].splice(a,1)}},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.JSA=e):t.JSA=e}}).call(this);